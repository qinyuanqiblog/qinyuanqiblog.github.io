---
title: nodjs çˆ¬å–å–œæ¬¢çš„çš„èƒŒæ™¯å›¾ç‰‡
date: 2023-04-25 16:56:19
permalink: /pages/873b11/
categories:
  - web
  - frame
  - node
tags:
  - 
---



* ç›´æ¥ä»å¹•å¸ƒè€ƒè¿‡æ¥çš„ï¼Œæ‡’å¾—æ”¹æ’ç‰ˆäº†ï¼Œ ğŸ˜„ğŸ˜„ğŸ˜„ï¼Œ
* å¹•å¸ƒåœ°å€ï¼š https://mubu.com/doc/_77_RCP9GG
*   å‰è¨€
    
    *   å…¬å¸æ¬å®¶äº†ï¼Œ æ¢äº†æ–°çš„ç”µè„‘ï¼Œ æ„Ÿè§‰æ¡Œé¢æœ‰ç‚¹ç©ºè¡è¡ï¼Œæƒ³å»æå‡ å¼ é«˜çº§çš„èƒŒæ™¯å›¾ç‰‡æ¥è£…ä¸‹13ï¼Œäºæ˜¯ä¾¿æœ‰äº†è¿™ä¸ªé¡¹ç›®
        
    
    *   ç»è¿‡ä¸€ç•ªè°·æ­Œï¼Œæ„Ÿè§‰æ¯”è¾ƒå–œæ¬¢[wallhaven](https://wallhaven.cc/toplist?page=2)è¿™ç§é£æ ¼çš„èƒŒæ™¯å›¾ï¼Œå¼€å§‹æèµ· ~~~
        
*   æææ
    
    *   æ€è·¯
        
        *   1. è§£æé¡µé¢ï¼Œåˆ†æé¡µé¢ç»“æ„ï¼Œç„¶åæ‹¿åˆ°å›¾ç‰‡åœ°å€
            
        
        *   2. ç„¶åå‘èµ·è¯·æ±‚ï¼Œåªç”¨å†™å…¥æœ¬åœ°
            
    
    *   å…·ä½“æ“ä½œ
        
        *   è§£æé¡µé¢ï¼Œåˆ†æé¡µé¢ç»“æ„ï¼Œç„¶åæ‹¿åˆ°å›¾ç‰‡åœ°å€ï¼Œ
            
            *   ç¼©ç•¥å›¾çš„é¡µé¢ç»“æ„![](https://api2.mubu.com/v3/document_image/62157013-083e-4ada-b9e3-e7099ee31107-2331693.jpg)
                
            
            *   è¯¦æƒ…å›¾çš„é¡µé¢ç»“æ„![](https://api2.mubu.com/v3/document_image/c3fa954c-c0be-44d6-aca7-f14ea5236be1-2331693.jpg)
                
            
            *   ç¼©ç•¥å›¾åœ°å€ï¼š [https://th.wallhaven.cc/small/rd/rd7dlq.jpg](https://th.wallhaven.cc/small/rd/rd7dlq.jpg)
                
            
            *   å¤§å›¾åœ°å€ï¼š [https://w.wallhaven.cc/full/rd/wallhaven-rd7dlq.jpg](https://w.wallhaven.cc/full/rd/wallhaven-rd7dlq.jpg)
                
            
            *   æ‰¾è§„å¾‹
                *   é€šè¿‡çŸ¥é“å°å›¾åœ°å€ï¼Œæ‰¾å‡ºå¤§å›¾åœ°å€ï¼Œä¸åŒç½‘ç«™ä¸åŒå“¦![](https://api2.mubu.com/v3/document_image/88d4b1c7-a7c2-4eeb-b66b-5d4dd173b281-2331693.jpg)
                    
            
            *   æ‰¾åˆ†é¡µæ¥å£
                *   ![](https://api2.mubu.com/v3/document_image/c9b50b15-d126-4a78-9c75-25f807b02180-2331693.jpg)
                    
        
        *   çŸ¥é“ç½‘ç«™çš„å¸ƒå±€å’Œè§„å¾‹ä¹‹åï¼Œæˆ‘ä»¬å°±å¯ä»¥å¼€å§‹ç¼–ç äº†
            
        
        *   ç¼–ç æ€è·¯ï¼š
            *   å…ˆæŠŠæ‰€æœ‰çš„ç¼©ç•¥å›¾éƒ½çˆ¬å–å‡ºæ¥ï¼Œçˆ¬å®Œä¹‹åï¼Œå†æŒ‰ç…§æ¯æ¬¡10ä¸ª ï¼Œ10ç§’ä¸€æ¬¡å»ä¸‹è½½ï¼Œç„¶åå†™å…¥æœ¬åœ°
                
        
        *   å…·ä½“æ­¥éª¤
            
            *   [Express åº”ç”¨ç¨‹åºç”Ÿæˆå™¨](https://expressjs.com/zh-cn/starter/generator.html)æ¥æ„å»ºä¸€ä¸ªexpressåº”ç”¨ï¼Œå…·ä½“æ­¥éª¤å‚è€ƒå®˜ç½‘
                
            
            *   éœ€è¦ä½¿ç”¨çš„åº“
                
                *   [consola](https://www.npmjs.com/package/consola) è®©æ—¥å¿—å¥½çœ‹ç‚¹ï¼Œæ–¹ä¾¿è§‚èµ
                    
                
                *   [cheerio](https://www.npmjs.com/package/cheerio) node ç‰ˆæœ¬çš„jqueryï¼Œç”¨æ¥è§£æé¡µé¢
                    
                
                *   [axios](https://www.npmjs.com/package/axios) å‘é€è¯·æ±‚ï¼Œä¸‹è½½å›¾ç‰‡
                    
            
            *   æ ¸å¿ƒä»£ç 
                
                *   1. å‘èµ·è¯·æ±‚ï¼Œè·å–åˆ°ç¼©ç•¥å›¾çš„åœ°å€ï¼Œç„¶åå­˜åˆ°ä¸€ä¸ªæ•°ç»„é‡Œé¢![](https://api2.mubu.com/v3/document_image/c65684ce-7c8a-4e50-bce4-9f065455cf2f-2331693.jpg)
                    
                
                *   2. è½®è¯¢ï¼Œè°ƒç”¨åˆ†é¡µæ¥å£è·å–ç¼©ç•¥å›¾åœ°å€![](https://api2.mubu.com/v3/document_image/44eb1bc1-8fd3-43bb-b06f-44ab83389e27-2331693.jpg)
                    
                
                *   3. ä¸‹è½½å›¾ç‰‡ï¼Œç„¶åå­˜å‚¨åˆ°æœ¬åœ°ç”µè„‘ï¼Œæ¥¼ä¸»ä½¿ç”¨ä¸‡å¹´windowï¼Œç©·ğŸ˜„![](https://api2.mubu.com/v3/document_image/ac9552bd-cdc6-4c10-89bb-20926431e408-2331693.jpg)
                    
                
                *   4. æ•ˆæœï¼Œç¾æ»‹æ»‹
                    *   ![](https://api2.mubu.com/v3/document_image/7980e5ac-450c-43c1-bf8f-93f91080aa7c-2331693.jpg)
                    *   5æ ¸å¿ƒä»£ç 
                    
```
const reptileUrl = 'https://wallhaven.cc/toplist?page='
// æœ¬åœ°å­˜å‚¨è·¯å¾„
const saveDir = 'E:/myExpressDownload/toplist3/'
let currentPage = 1
const maxPage = 2

const imgUrlList = []


init()

/**
 * çˆ¬å–ä¸»ç¨‹åºå…¥å£
 */
async function init() {
    log.info('ä¸»ç¨‹åºå¼€å§‹å¯åŠ¨ï¼Œè¯·æ‚¨è€å¿ƒç­‰å¾…~')
    log.info(`å¼€å§‹çˆ¬å–${reptileUrl}çš„å›¾ç‰‡`)
    log.info(`æ–‡ä»¶å°†ä¼šè¢«ä¿å­˜åˆ°ä»¥ä¸‹åœ°å€ä¸­ï¼š${saveDir}`)

    // åˆ¤æ–­æœ¬åœ°å­˜å‚¨æ–‡ä»¶å¤¹æ˜¯å¦å­˜åœ¨
    if (!fs.existsSync(saveDir)) {
        log.info('ç›®æ ‡æ–‡ä»¶ä¸å­˜åœ¨ï¼Œå¼€å§‹åˆ›å»ºæ–°çš„æ–‡ä»¶å¤¹~')
        fs.mkdirSync(saveDir);
    }

    if (currentPage > maxPage) {
        log.error('è¶…å‡ºæœ€å¤§é¡µæ•°ï¼Œåœæ­¢æ”¶é›†æºæ•°æ®ï¼Œå¼€å§‹çˆ¬å–å›¾ç‰‡~')
        try {
            const downloadTimer = setInterval(() => {
                if(!imgUrlList.length){
                    log.error('æ²¡æœ‰æ›´å¤šäº†ï¼Œæ”¶å·¥äº†~~~~')
                    clearInterval(downloadTimer)
                    return false
                }
                log.success('å¼€å§‹è½®è¯¢ä¸‹è½½å›¾ç‰‡~')
                downloadPicture(imgUrlList.splice(0, 10))
            }, 10000);
        } catch (error) {
            log.error(`downloadPicture fail===>`, error)
        }
        
        // const downloadTimer  = setInterval(() => {
        //     if(!imgUrlList.length){
        //         log.error('æ²¡æœ‰å›¾ç‰‡äº†ï¼Œ ç»ˆäºå¹²å®Œæ´»äº†ï¼Œ ç´¯æ­»äº†~~~')
        //         clearInterval(downloadTimer)
        //     }
        //     log.success('å¼€å§‹è½®è¯¢ä¸‹è½½å›¾ç‰‡å’¯~')
        //     downloadPicture(imgUrlList.splice(0, 10))
        // }, 20000);
        return false
    }
    try {
        log.info(`å¼€å§‹çˆ¬å–ç¬¬${currentPage}é¡µ`)
        const websiteHtml = await axiosRequest.get(`${reptileUrl}${currentPage}`)
        const html = websiteHtml
        const $ = cheerio.load(html);
        $('.thumb img').each((i, v) => {
            const smallUrl =  v.attribs['data-src'] ||  v.attribs.src
            const urlArray = smallUrl.split('/')
            const fileName = urlArray[urlArray.length-1]
            const fullUrl = `https://w.wallhaven.cc/full/${fileName.substring(0, 2)}/wallhaven-${fileName}`
            smallUrl && imgUrlList.push({
                        smallUrl: smallUrl,
                        fullUrl: fullUrl,
                        fileName
                    })
            
        })

        log.error(`imgUrlList==>`, imgUrlList)
        sleep(init)
    } catch (error) {
        log.error(`çˆ¬å–é”™è¯¯ï¼Œé”™è¯¯ä¿¡æ¯å¦‚ä¸‹==>`, error)
    }
}

function sleep(callback) {
    currentPage++
    const sleepTimeout = commonUtils.getRandomNumber(1, 10)
    let copyTimeout = sleepTimeout
    log.info(`çˆ¬å¤ªå¤šäº†ï¼Œæœ‰ç‚¹ç´¯äº†ï¼Œä¼‘æ¯${sleepTimeout}ç§’ï¼Œåå†ç»§ç»­ğŸ˜„`)
    const logTimer = setInterval(() => {
        if (copyTimeout <= 1) {
            clearInterval(logTimer)
        }
        log.success(`å€’è®¡æ—¶  ${--copyTimeout}   ç§’åå¼€å§‹ç»§ç»­å¹²æ´»~`)
    }, 1000);
    setTimeout(() => {
        typeof callback === 'function'  &&  callback()
    }, sleepTimeout * 1000);
}

async function findPicture(aTagArray) {
    log.info('å¼€å§‹è§£æå›¾ç‰‡å†…å®¹~')
    const array = aTagArray.map(v => axiosRequest.get(v))
    return Promise.all(array)
}


function downloadPicture(pictureArray) {
    log.info('å¼€å§‹å‘é€è¯·æ±‚ä¸‹è½½å›¾ç‰‡~')
    return pictureArray.reduce((accumulator, currentValue, currentIndex, array) => {
        console.log(currentValue.fullUrl, 'currentValue.fullUrl')
        const promise = axiosRequest.get(currentValue.fullUrl, {
            responseType: 'stream'
        }).then(res => {
            const result = res.pipe(fs.createWriteStream(`${saveDir}${currentValue.fileName}`))
            log.success(`æˆåŠŸä¿å­˜å›¾ç‰‡åˆ°æœ¬åœ°ï¼Œä¿å­˜ä½ç½®==>${saveDir}${currentValue.fileName}`)
        })
        accumulator.push(promise)
        return accumulator
    }, [])
}
```
                        
                
* å®Œæ•´ä»£ç 
    * https://github.com/qinyuanqiblog/express-demo

                        
*   ç»“æŸè¯­
    
    *   æœ¬æ–‡å¦‚æœ‰é”™è¯¯ï¼Œæ¬¢è¿æŒ‡æ­£ï¼Œéå¸¸æ„Ÿè°¢
        
    
    *   è§‰å¾—æœ‰ç”¨çš„è€é“ï¼Œç‚¹ä¸ªåŒå‡»ï¼Œå°çº¢å¿ƒèµ°ä¸€æ³¢
        
    
    *   æ¬¢è¿çŒæ°´ï¼Œæ¥å‘€ï¼Œäº’ç›¸ä¼¤å®³å“ˆ o(âˆ©_âˆ©)o å“ˆå“ˆ